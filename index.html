<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DSS Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 2em auto; }
    .hidden { display: none; }
    button { margin-top: 1em; }
  </style>
</head>
<body>
  <h1>DSS Quiz 2</h1>

  <div id="status">Checking your accessâ€¦</div>
  <div id="quiz" class="hidden">
    <h2 id="welcome"></h2>
    <div id="timer">Time: 0s</div>
    <form id="quizForm">
      <p>1. 2 + 2 = ?</p>
      <input type="radio" name="q1" value="3"> 3<br>
      <input type="radio" name="q1" value="4"> 4<br>
      <input type="radio" name="q1" value="5"> 5<br>

      <p>2. Capital of Oman?</p>
      <input type="radio" name="q2" value="Dubai"> Dubai<br>
      <input type="radio" name="q2" value="Muscat"> Muscat<br>
      <input type="radio" name="q2" value="Salalah"> Salalah<br>

      <button type="submit">Submit</button>
    </form>
  </div>
  <div id="result" class="hidden"></div>

  <script>
    // ðŸ‘‰ Replace with your latest Web App URL (must end with /exec)
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycb.../exec';

    const token = new URLSearchParams(location.search).get('token');
    const statusEl = document.getElementById('status');
    const quizEl   = document.getElementById('quiz');
    const resultEl = document.getElementById('result');
    const welcomeEl= document.getElementById('welcome');
    const timerEl  = document.getElementById('timer');

    let startTime, timerInt;

    // --- 1. Validate token on load ---
    if (!token) {
      statusEl.textContent = "Missing token in URL.";
    } else {
      console.log("GET check:", `${BACKEND_URL}?token=${token}`);
      fetch(`${BACKEND_URL}?token=${encodeURIComponent(token)}`)
        .then(r => r.json())
        .then(data => {
          console.log("GET response:", data);
          if (data.ok) {
            statusEl.classList.add('hidden');
            welcomeEl.textContent = "Welcome, " + data.participant.name;
            quizEl.classList.remove('hidden');
            startTimer();
          } else {
            statusEl.textContent = "Access denied: " + data.error;
          }
        })
        .catch(err => {
          console.error(err);
          statusEl.textContent = "Network error (GET): " + err;
        });
    }

    // --- 2. Timer ---
    function startTimer() {
      startTime = Date.now();
      timerInt = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime)/1000);
        timerEl.textContent = "Time: " + elapsed + "s";
      }, 1000);
    }

    // --- 3. Submit handler ---
    document.getElementById('quizForm').addEventListener('submit', e => {
      e.preventDefault();
      clearInterval(timerInt);

      const elapsed = Math.floor((Date.now() - startTime)/1000);

      // Simple scoring
      let rawScore = 0;
      const answers = {};
      const form = new FormData(e.target);
      if (form.get('q1') === '4') rawScore++;
      if (form.get('q2') === 'Muscat') rawScore++;
      answers.q1 = form.get('q1');
      answers.q2 = form.get('q2');

      const payload = {
        token,
        quiz_id: "quiz-001",
        raw_score: rawScore,
        time_sec: elapsed,
        answers_json: answers,
        user_agent: navigator.userAgent
      };

      console.log("POSTing to:", BACKEND_URL, payload);

      // --- 4. POST to backend ---
      fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
        console.log("POST response:", data);
        quizEl.classList.add('hidden');
        resultEl.classList.remove('hidden');
        if (data.ok) {
          resultEl.textContent = `Final Score: ${data.final_score} (multiplier ${data.multiplier})`;
        } else {
          resultEl.textContent = "Error: " + data.error;
        }
      })
      .catch(err => {
        console.error("POST error:", err);
        resultEl.classList.remove('hidden');
        resultEl.textContent = "Network error (POST): " + err;
      });
    });
  </script>
</body>
</html>
